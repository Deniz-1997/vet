# Общие компоненты валидации форм

### Содержание

- [Базовое использование](#базовое-использование)
  - [Работа с компонентами](#работа-с-компонентами)
  - [Определение правил](#определение-правил)
  - [Переопределение сообщений об ошибках](#переопределение-сообщений-об-ошибках)
  - [Создание новых контролов](#создание-новых-контролов)
- [Добавление кастомных правил](#добавление-кастомных-правил)
- [API](#api)
  - [UiForm](#uiform)
  - [UiControl](#uicontrol)
  - [UiCheckbox](#uicheckbox)
- [Кастомные правила](#кастомные-правила)

---

## Базовое использование

Для удобной работы с валидацией и отображением ошибок валидации UI форм, разработаны компоненты, упрощающие этот процесс.
Код базируется на библиотеке [ValidatorJS](https://github.com/mikeerickson/validatorjs).

### Работа с компонентами

Базовая структура валидируемой формы должна выглядеть следующим образом:

```yaml
- UiForm
  - UiControl
  - ...
  - UiControl
  - button[type=submit]
```

, где:

- `UiControl` -- это любой контрол, [удовлетворяющий](#добавление-кастомных-правил) использованию в качестве контрола валидируемой формы.
- `button[type=submit]` -- кнопка соответствующего типа. Нажатие на неё триггерит вызов события `submit` формы.

Также форма может содержать любые другие компоненты и элементы. Они не влияют на работу валидируемой формы.

Следить за валидностью можно, получая обновления валидации из события `validation` формы.

Таким образом, базовый пример использования валидируемой формы будет выглядеть так:

```html
<template>
  <UiForm :rules="rules" :messages="messages" @validation="(v) => isValid = v.isValid" @submit="onSubmit">
    <UiControl :value="form.name">
      <input v-model="form.name" />
    </UiControl>
    <button type="submit" :disabled="!isValid">Submit</button>
  </UiForm>
</template>
```

```typescript
<script lang="ts">
import { Component, Vue } from 'vue-property-decorator';

@Component({ name: 'UiInput' })
export default class extends Vue {
  private isValid = false;
  private form = {
    name: 'John Doe',
  };

  get rules() {
    return {
      name: 'required',
    };
  }

  get messages() {
    return {
      'required.name': 'Вас должны как-то звать',
    };
  }

  onSubmit(data) {
    console.log(data); // { name: 'John Doe' }
    this.$axios.post('/api/create', data);
  }
}
</script>
```

Использование `button[type=submit]` и обработки формы через соответствующее событие обязательно! Иначе не будет отрабатываться дефолтное поведение валидации в соответствии с пропсой `validateOn`.

### Определение правил

Правила задаются в соответствии с name, определенными в шаблоне для контролов формы. Список правил по умолчанию можно посмотреть [здесь](https://github.com/mikeerickson/validatorjs#available-rules). Список кастомных правил доступен [ниже](#кастомные-правила).

```typescript
get rules() {
  return {
    name: 'required',
    email: 'required|email',
    age: 'min:18'
  };
}

// Список правил можно задать строкой
email: 'required|email|size:10',

// Объектом
email: [{ required: true, email: true, size: 10 }],

// В массиве подходы могут быть скомбинированы.
email: ['required|email', { size: 10 }],

```

Добавлена возможность передавать правила по условию.

```typescript
get rules() {
  return {
    startTime: !this.isOKPD2 && 'required',
    symbol: [this.modal.includes('symbol') && 'required'],
    code: [this.modal.includes('code') && 'required', 'alpha'],
  };
}
```

Сформированный список `rules` необходимо передать в соответствующий `prop` компонента `UiForm`.

### Переопределение сообщений об ошибках

Сообщения об ошибках можно переопределить, если передать в свойство `message` компонента `UiForm` список необходимых текстовок. Ключи списка названия правил с опциональным указание названия контрола, для которого они применяются. Если контрол указан, изменится текст ошибки данного правила только для указанного контрола, иначе -- для любой ошибки такого типа в этой валидируемой форме.

```typescript
get messages() {
  return {
    // Такая ошибка выведется для любого незаполненного поля.
    required: 'Поле обязательно для заполнения',
    // Такая ошибка выведется только для поля `name`.
    'required.name': 'Необходимо указать имя пользователя',
    // Здесь вместо :attribute подставится `name` контрола.
    email: 'Полe :attribute должно соответствовать формату x@x.x',
    // Здесь вместо :size подставится значение, переданное при определении правил валидации.
    size: 'Ваш ИНН должен содержать :size цифр',
  };
}
```

### Создание новых контролов

При создании новых контролов следует закладывать в них возможность использования в качестве контрола валидируемой формы. Такой контрол может быть зарегистрирован в качестве глобального компонента и использоваться на проекте повсеместно.

Для создания контрола, удовлетворяющего требованиям использования в качестве элемента валидируемой формы, следует в качестве миксина для него использовать компонент [UiControl](./UiControl.vue).

```typescript
import { Component, Mixins } from 'vue-property-decorator';
import UiControl from '@/components/global/UiForm/UiControl.vue';

@Component({ name: 'UiInput' })
export default class extends Mixins([UiControl]) {
  // Some dedicated logic.
}
```

Следует понимать, что такой подход будет актуален только для компонентов с прямой логикой, где value является главным свойством, определяющим значение. В случае, если v-model используется для синхронизации других состояний или value компонента логически не подходит для корректного валидирования, следует реализовать компонент как обёртку:

```html
<template>
  <UiControl :name="name" :value="checked && value">
    <input type="checkbox" />
    <span #error="{ error }">{{ error }}</span>
  </UiControl>
</template>
```

```typescript
<script lang="ts">
import { Component, Vue } from 'vue-property-decorator';

@Component({ name: 'UiCheckbox' })
export default class extends Vue {
  // Some dedicated logic.
}
</script>

```

---

## Добавление кастомных правил

Набор правил, предлагаемого библиотекой, может не покрыть нужды приложения. В таком случае, необходимо написать кастомный валидатор. Для добавления необходимо:

1. Создать в директории `rules` ts-файл с названием, идентичным названию валидатора в camelCase;
2. Описать в нём правило в формате [TValidationOptions](./models.ts#TValidationOptions);
3. Код должен быть откомментирован, если необходимо, и покрыт тестами минимум на 80%;
4. Валидатор нужно подключить в файле [rules/index.ts](./rules/index.ts);
5. Информацию о валидаторе нужно добавить в [список кастомных правил](#кастомные-правила).

Пример подключения:

```typescript
// rules/tel.ts

export default {
  handler(value) {
    // Очищаем значение от всех нечисловых знаков.
    const number = value.replace(/\D/g, '');
    return /[78]\d{10}/g.test(number);
  },
  message: 'Некорректный формат номера',
} as TValidationOptions;
```

```typescript
// rules/index.ts
import tel from './tel.ts';

export default {
  tel,
} as TValidationRules;
```

---

## API

### UiForm

#### Props

| Name       | Description                                                                                                                                                   | Required | Default                      |
| ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- | :------: | ---------------------------- |
| rules      | Список правил для контролов формы                                                                                                                             |    V     |                              |
| messages   | Список сообщений об ошибках                                                                                                                                   |    X     | Набор сообщений по умолчанию |
| validateOn | Алгоритм валидации: `submit` или `input`. Если `submit`, форма впервые показывает ошибки при первой попытке отправки. Иначе -- при первом нажатии на контрол. |    X     | submit                       |

#### Events

| Name       | Description                                        | Data                                                                               |
| ---------- | -------------------------------------------------- | ---------------------------------------------------------------------------------- |
| validation | Событие изменения состояния валидности формы       | { isValid: boolean, errors: {}, data: {} }                                         |
| submit     | Событие нажатия на вложенную кнопку с типом submit | Собранные из вложенных контролов данные в формате {[Control.name]: Control.value}. |

#### Slots

| Name    | Description | Data |
| ------- | ----------- | ---- |
| default | —           | —    |

### UiControl

#### Props

| Name        | Description                                                | Required | Default |
| ----------- | ---------------------------------------------------------- | :------: | ------- |
| value       | Значение контрола, по которому будет проводится валидация  |    V     |         |
| name        | Наименование, по которому будет сопоставляться валидация   |    V     |
| hideMessage | Флаг для отключения отображения текста ошибки по умолчанию |    X     | false   |

#### Slots

| Name    | Description                                     | Data                |
| ------- | ----------------------------------------------- | ------------------- |
| default | —                                               | {errors?: string[]} |
| error   | Заменяет отображение текста ошибки по умолчанию | {errors?: string[]} |

---

### UiCheckbox

Валидируемый чекбокс.

#### Props

| Name     | Description                                                                                                                                                  | Required | Default       |
| -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------ | :------: | ------------- |
| checked  | Флаг, нажат ли чекбокс                                                                                                                                       |    V     | false         |
| value    | Значение контрола, по которому будет проводится валидация, принимает массив, где первый элемент -- значение, которое вернутся для true, второе -- для false. |    V     | [true, false] |
| name     | Наименование, по которому будет сопоставляться валидация                                                                                                     |    V     |               |
| id       | Идентификатор элемента                                                                                                                                       |    V     |               |
| label    | Текст чекбокса                                                                                                                                               |    X     | ''            |
| disabled | Флаг доступности для взаимодействия                                                                                                                          |    X     | false         |

#### Events

| Name  | Description        | Data    |
| ----- | ------------------ | ------- |
| input | Изменение значения | boolean |

---

## Кастомные правила
